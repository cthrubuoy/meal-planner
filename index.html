<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meal Planner & Shopping List ‚Äî v7</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b0f1a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    :root { --bg:#0b0f1a; --panel:#101826; --card:#0b1220; --text:#e5e7eb; --muted:#94a3b8; --chip:#1f2937; --danger:#ef4444; --accent:#22c55e; --gold:#facc15; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.35); --card-min:260px; }
    [data-theme="light"] { --bg:#f6f7fb; --panel:#fff; --card:#fff; --text:#111827; --muted:#64748b; --chip:#e5e7eb; --danger:#ef4444; --accent:#16a34a; --gold:#b45309; --shadow:0 6px 20px rgba(0,0,0,.08); }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg, var(--bg), #0a0f1c 45%, #0a0e19);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    header{position:sticky;top:0;z-index:6;backdrop-filter:blur(6px);background:rgba(10,14,25,.6);border-bottom:1px solid rgba(255,255,255,.06)}
    [data-theme="light"] header{background:rgba(255,255,255,.8)}
    .wrap{width:100%;padding:14px 18px}
    h1{margin:0;font-size:1.2rem;display:flex;align-items:center;gap:10px}
    .pill{font-size:.75rem;color:#a3e635;background:rgba(163,230,53,.13);border:1px solid rgba(163,230,53,.35);padding:2px 8px;border-radius:999px}

    main{display:grid;grid-template-columns:420px 1fr;gap:18px;padding:18px}
    @media (max-width:980px){main{grid-template-columns:1fr}}

    .panel{background:linear-gradient(180deg, var(--panel), var(--card));border:1px solid rgba(255,255,255,.06);border-radius:18px;box-shadow:var(--shadow)}
    .inner{padding:16px}
    h2{margin:0 0 10px;font-size:1.05rem}

    label{font-size:.9rem;color:var(--muted)}
    input[type=text],input[type=number],input[type=file],select{background:var(--card);border:1px solid rgba(255,255,255,.12);color:var(--text);padding:10px 12px;border-radius:10px;width:100%}
    textarea{background:var(--card);border:1px solid rgba(255,255,255,.12);color:var(--text);padding:10px 12px;border-radius:10px;width:100%;resize:vertical}
    .btn{border:1px solid rgba(255,255,255,.12);background:#111827;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    [data-theme="light"] .btn{background:#111827;color:#e5e7eb}
    .btn.primary{background:linear-gradient(180deg,#1f8e54,#1b7b49);border-color:rgba(34,197,94,.5)}
    .btn.danger{background:linear-gradient(180deg,#b3262f,#991b1b);border-color:rgba(239,68,68,.5)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:10px}
    .group{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted)}

    .ingredients{display:grid;gap:10px}
    .ingredient-row{display:grid;grid-template-columns:2fr 1.1fr 1fr 1fr auto;gap:8px;align-items:center}
    .ingredient-row .remove{background:var(--danger);border:none;color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer}

    .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(var(--card-min),1fr));gap:14px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;overflow:hidden;box-shadow:var(--shadow);display:grid;grid-template-rows:160px auto}
    .media{position:relative}
    .card img{width:100%;height:100%;object-fit:cover;display:block;filter:blur(10px);transition:filter .35s ease}
    .card img.ready{filter:blur(0)}
    .select{position:absolute;top:10px;left:10px;display:flex;align-items:center;gap:8px;background:rgba(2,6,23,.6);border:1px solid rgba(255,255,255,.15);padding:6px 10px;border-radius:999px}
    .fav{position:absolute;top:10px;right:10px;border-radius:999px;border:1px solid rgba(255,255,255,.15);background:rgba(2,6,23,.6);color:var(--gold);padding:6px 10px;cursor:pointer;display:flex;align-items:center;gap:6px}
    .fav[data-on=true]{background:rgba(250,204,21,.18);border-color:rgba(250,204,21,.5)}
    .card h3{margin:12px 12px 8px;font-size:1.05rem}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin:0 12px 12px}
    .chip{font-size:.75rem;background:var(--chip);color:#cbd5e1;border:1px solid rgba(255,255,255,.08);padding:4px 8px;border-radius:999px}
    .no-tags{margin:0 12px 12px;color:var(--muted);font-size:.85rem;cursor:pointer;text-decoration:underline dotted 1px transparent}
    .no-tags:hover{ text-decoration-color: rgba(255,255,255,.35) }
    .controls{display:flex;gap:8px;margin:0 12px 12px}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px dashed rgba(255,255,255,.08);text-align:left}
    tfoot td{color:var(--muted);font-size:.9rem}
    .empty{color:var(--muted);font-style:italic;text-align:center;padding:12px;border:1px dashed rgba(255,255,255,.12);border-radius:12px}

    /* Tag strip (single row, scroll, fade) */
    .tagbar{display:flex;gap:8px;flex-wrap:nowrap;overflow-x:auto;white-space:nowrap;position:relative;padding-bottom:4px}
    .tagbar::-webkit-scrollbar{display:none}
    .tagbar::after{content:"";position:absolute;right:0;top:0;width:48px;height:100%;pointer-events:none;background:linear-gradient(90deg,rgba(0,0,0,0), var(--panel))}
    .tag{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);cursor:pointer;color:var(--text)!important;background:var(--chip);display:inline-flex;align-items:center;gap:6px}
    .tag.active{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.5)}
    [data-theme="light"] .tag{color:#111827}
    .tag .count{font-size:.75rem;color:var(--muted)}

    .popover{position:fixed;z-index:60;background:var(--panel);border:1px solid rgba(255,255,255,.12);border-radius:12px;box-shadow:var(--shadow);padding:12px;max-width:min(480px,94vw)}
    .pop-title{font-weight:600;margin-bottom:6px}
    .pop-sub{margin:.25rem 0 .35rem;color:var(--muted);font-size:.85rem}
    .pop-row{display:flex;gap:8px;align-items:center;margin:8px 0}
    .pop-list{max-height:260px;overflow:auto;display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .pop-chip{border:1px solid rgba(255,255,255,.14);border-radius:999px;padding:6px 10px;display:flex;align-items:center;gap:6px;cursor:pointer;background:var(--card)}
    .pop-chip.active{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.5)}

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.6);z-index:50}
    .modal.open{display:flex}
    .dialog{width:min(900px,96vw);background:linear-gradient(180deg,var(--panel),var(--card));border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:var(--shadow);padding:16px}

    /* Fix: keep dialogs inside viewport + scroll internally */
    .dialog{max-height:calc(100vh - 32px); overflow:auto}

    /* Sticky headers inside modals */
    #edit-modal .toolbar, #settings-modal .toolbar{position:sticky;top:0;z-index:1;background:linear-gradient(180deg,var(--panel),var(--card));padding-bottom:10px;margin-bottom:10px;border-bottom:1px solid rgba(255,255,255,.08)}

    body.modal-open{overflow:hidden}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){.row{grid-template-columns:1fr}}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px dashed rgba(255,255,255,.12);padding:8px 10px;text-align:left}

    /* Time slider */
    .range { display:flex; align-items:center; gap:10px; }
    .range input[type=range] { width:140px; }

    /* Steps */
    .steps { display:grid; gap:8px; margin-top:8px; }
    .step-row{ display:grid; grid-template-columns: 1fr auto auto auto; gap:8px; align-items:center; }
    .step-row .step-text{ padding:10px 12px; border:1px solid rgba(255,255,255,.12); border-radius:10px; background:var(--card); }
    .step-row .mini { padding:8px 10px; border-radius:10px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between">
      <h1>üõí Meal Planner & Shopping List <span class="pill">v7</span></h1>
      <div class="group">
        <button class="btn" id="theme-toggle" title="Toggle theme">üåô</button>
        <button class="btn" id="settings">Settings</button>
      </div>
    </div>
  </header>

  <main>
    <section class="panel">
      <div class="inner">
        <h2>Add a meal</h2>
        <form id="meal-form">
          <div class="form-row">
            <label for="title">Meal name</label>
            <input id="title" type="text" placeholder="e.g. Chicken fajitas" required maxlength="80" />
          </div>
          <div class="form-row">
            <label for="image-file">Photo (upload)</label>
            <input id="image-file" type="file" accept="image/*" />
            <small class="muted">Large images are auto‚Äëcompressed; very large files will be down‚Äëscaled.</small>
          </div>

          <div class="form-row">
            <label for="cook-mins">Time to cook (mins)</label>
            <input id="cook-mins" type="number" min="0" max="120" step="5" placeholder="e.g. 30" />
          </div>

          <div class="form-row">
            <div class="group" style="width:100%;justify-content:space-between">
              <label>Ingredients</label>
              <small class="muted" id="ing-hint">Qty supports an optional unit label (e.g. pack)</small>
            </div>
            <div id="ingredients" class="ingredients" aria-live="polite"></div>
            <div class="group">
              <button class="btn" type="button" id="add-ingredient">+ Add ingredient</button>
              <button class="btn" type="button" id="duplicate-last" title="Duplicate last meal">Duplicate last</button>
            </div>
          </div>

          <div class="form-row">
            <label>Tags (auto‚Äëseeded from ingredients; comma or Enter to add)</label>
            <div class="group" id="tags-editor"></div>
            <input id="tags-input" type="text" list="tag-suggestions" placeholder="e.g. veggie, quick" />
          </div>

          <div class="form-row">
            <label>Steps</label>
            <div class="group">
              <input id="step-input" type="text" placeholder="Add a step (e.g. Fry onions for 5 mins)" />
              <button class="btn" type="button" id="add-step">+ Add step</button>
            </div>
            <div id="steps" class="steps"></div>
            <small class="muted">Use the arrows to reorder.</small>
          </div>

          <div class="form-row">
            <label for="notes">Notes</label>
            <textarea id="notes" rows="4" placeholder="Optional notes (e.g. less chilli for kids, freezes well)"></textarea>
          </div>

          <div class="form-row">
            <div class="group">
              <button class="btn primary" type="submit">Add meal</button>
              <button class="btn" type="reset" id="reset-form">Reset</button>
            </div>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);margin:14px 0" />
          <div class="toolbar">
            <div class="group">
              <button class="btn" id="export">Export</button>
              <label class="btn" for="import">Import</label>
              <input id="import" type="file" accept="application/json" style="display:none" />
              <button class="btn danger" id="clear-all">Clear all</button>
            </div>
            <span class="muted" id="status"></span>
          </div>
        </form>
      </div>
    </section>

    <section class="panel">
      <div class="inner">
        <div class="toolbar">
          <h2 style="margin:0">Your meals</h2>
          <div class="group">
            <input id="search" type="text" placeholder="Search titles‚Ä¶" style="width:220px" />
            <div class="group" title="Filter by time">
              <span class="muted">‚è±</span>
              <div class="range">
                <input id="time-min" type="range" min="0" max="120" step="5" value="0" />
                <span class="muted" id="time-label">0‚Äì120 min</span>
                <input id="time-max" type="range" min="0" max="120" step="5" value="120" />
                <button class="btn" id="time-clear" title="Clear time filter">Clear</button>
              </div>
            </div>
            <button class="btn" id="toggle-favs">Show favourites only</button>
            <label class="muted">Grid</label>
            <button class="btn" data-density="compact">Compact</button>
            <button class="btn" data-density="cozy">Cozy</button>
            <button class="btn" data-density="comfy">Comfy</button>
          </div>
        </div>

        <div class="toolbar" style="margin-top:-4px">
          <div class="tagbar" id="tag-bar" title="Scroll to see more tags"></div>
          <div class="group">
            <button class="btn" id="tag-filter">Filter by tag ‚ñæ</button>
            <span class="muted" id="tag-active"></span>
          </div>
        </div>

        <div id="meal-grid" class="grid" aria-live="polite"></div>

        <h2 style="margin-top:18px">Shopping list</h2>
        <div class="toolbar">
          <div class="group">
            <button class="btn" id="copy-tsv" title="Copy as tab‚Äëseparated for Excel">Copy as TSV</button>
            <button class="btn" id="print">Print</button>
          </div>
          <span class="muted">Tick meals to include</span>
        </div>
        <div id="shopping"></div>
      </div>
    </section>
  </main>

  <datalist id="ingredient-suggestions"></datalist>
  <datalist id="tag-suggestions"></datalist>

  <template id="ingredient-template">
    <div class="ingredient-row">
      <input type="text" placeholder="Ingredient (e.g. chicken breast)" list="ingredient-suggestions" required maxlength="80" />
      <select>
        <option value="grams">grams</option>
        <option value="ml">ml</option>
        <option value="tsp">tsp</option>
        <option value="tbsp">tbsp</option>
        <option value="cup">cup</option>
        <option value="qty">quantity</option>
      </select>
      <input type="number" min="0" step="any" placeholder="Amount" required />
      <input type="text" placeholder="Unit label (optional, e.g. pack, tin)" maxlength="24" />
      <button type="button" class="remove" title="Remove">√ó</button>
    </div>
  </template>

  <div id="edit-modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="dialog">
      <div class="toolbar" style="margin:0 0 6px">
        <h3 style="margin:0">Edit meal</h3>
        <button class="btn" id="edit-close">Close</button>
      </div>
      <form id="edit-form">
        <div class="form-row">
          <label for="edit-title">Meal name</label>
          <input id="edit-title" type="text" required maxlength="80" />
        </div>
        <div class="form-row">
          <label for="edit-image-file">Replace photo (upload)</label>
          <input id="edit-image-file" type="file" accept="image/*" />
        </div>
        <div class="form-row">
          <label for="edit-cook-mins">Time to cook (mins)</label>
          <input id="edit-cook-mins" type="number" min="0" max="120" step="5" />
        </div>
        <div class="form-row">
          <label>Ingredients</label>
          <div id="edit-ingredients" class="ingredients"></div>
          <button class="btn" type="button" id="edit-add-ingredient">+ Add ingredient</button>
        </div>
        <div class="form-row">
          <label>Tags</label>
          <div class="group" id="edit-tags-editor"></div>
          <div class="group">
            <input id="edit-tags-input" type="text" list="tag-suggestions" placeholder="Add a tag" />
            <button class="btn" id="edit-tags-from-ingredients" type="button" title="Merge in ingredient names as tags">Add ingredient names as tags</button>
          </div>
        </div>

        <div class="form-row">
          <label>Steps</label>
          <div class="group">
            <input id="edit-step-input" type="text" placeholder="Add a step" />
            <button class="btn" type="button" id="edit-add-step">+ Add step</button>
          </div>
          <div id="edit-steps" class="steps"></div>
        </div>

        <div class="form-row">
          <label for="edit-notes">Notes</label>
          <textarea id="edit-notes" rows="4"></textarea>
        </div>

        <div class="form-row">
          <button class="btn primary" type="submit">Save changes</button>
          <button class="btn" type="button" id="edit-cancel">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div id="settings-modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="dialog">
      <div class="toolbar" style="margin:0 0 6px">
        <h3 style="margin:0">Settings</h3>
        <button class="btn" id="settings-close">Close</button>
      </div>
      <div class="row">
        <section>
          <h4 style="margin:.2rem 0 .4rem">Ingredient normaliser</h4>
          <table class="table" id="norm-table">
            <thead><tr><th>Canonical</th><th>Aliases</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="group" style="margin-top:8px">
            <input id="norm-canonical" type="text" placeholder="e.g. spring onion" />
            <input id="norm-aliases" type="text" placeholder="aliases (comma‚Äëseparated)" />
            <button class="btn" id="norm-add">Add</button>
          </div>
        </section>
        <section>
          <h4 style="margin:.2rem 0 .4rem">Unit defaults</h4>
          <table class="table" id="unit-table">
            <thead><tr><th>Ingredient</th><th>Type</th><th>Unit label</th><th>Locked</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="group" style="margin-top:8px">
            <input id="unit-name" type="text" placeholder="e.g. chicken breast" />
            <select id="unit-type">
              <option value="grams">grams</option>
              <option value="ml">ml</option>
              <option value="tsp">tsp</option>
              <option value="tbsp">tbsp</option>
              <option value="cup">cup</option>
              <option value="qty">quantity</option>
            </select>
            <input id="unit-label" type="text" placeholder="unit label (for qty)" />
            <label><input id="unit-locked" type="checkbox" /> locked</label>
            <button class="btn" id="unit-add">Add/Update</button>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    const DB_NAME='mealPlannerDBv7';
    const STORE='kv';
    const IDB_KEYS={meals:'meals',normaliser:'normaliser',unitDefaults:'unitDefaults',prefs:'prefs'};
    const EXPORT_SCHEMA_VERSION=8; // steps + notes schema bump
    const NO_TAGS='__NO_TAGS__';

    function idbOpen(){return new Promise((resolve,reject)=>{const r=indexedDB.open(DB_NAME,1);r.onupgradeneeded=()=>r.result.createObjectStore(STORE);r.onsuccess=()=>resolve(r.result);r.onerror=()=>reject(r.error);});}
    async function idbGet(k){const db=await idbOpen();return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readonly');const rq=tx.objectStore(STORE).get(k);rq.onsuccess=()=>res(rq.result);rq.onerror=()=>rej(rq.error);});}
    async function idbSet(k,v){const db=await idbOpen();return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readwrite');const rq=tx.objectStore(STORE).put(v,k);rq.onsuccess=()=>res();rq.onerror=()=>rej(rq.error);});}

    const state={meals:[],selected:new Set(),editingId:null,showFavsOnly:false,search:'',tagFilter:new Set(),tagMode:'ANY',normaliser:[],unitDefaults:{},prefs:{theme:'auto',gridMin:'cozy', includeIngredientTags:false, tagStripMax:12}, timeFilter:{min:0,max:120}};

    const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s)); const uid=()=>Math.random().toString(36).slice(2,10);
    const status=(m,ms=2200)=>{const el=$('#status');el.textContent=m;if(ms)setTimeout(()=>{if(el.textContent===m)el.textContent='';},ms);};
    function escapeHtml(s){return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));}
    function titleCase(s){return s.toLowerCase().replace(/(^|\s|[-_])([a-z])/g,(_,p1,p2)=>p1+p2.toUpperCase());}
    function normaliseRaw(s){return s.trim().toLowerCase();}
    function normaliseKey(s){return s.trim().toLowerCase().replace(/[-_]/g,' ').replace(/\s+/g,' ').replace(/[^a-z0-9\s]/g,'');}
    function singularise(s){if(/ies$/.test(s))return s.replace(/ies$/,'y');if(/ses$/.test(s))return s.replace(/es$/,'');if(/s$/.test(s))return s.replace(/s$/,'');return s;}
    function formatNumber(n){const t=Math.round(n*100)/100;return Number.isInteger(t)?String(t):t.toFixed(2).replace(/\.00$/,'');}

    async function fileToCompressedDataURL(file){if(!file)return null;let warn=file.size>6*1024*1024;const img=await new Promise((res,rej)=>{const o=new Image();o.onload=()=>res(o);o.onerror=rej;o.src=URL.createObjectURL(file);});const tooBig=img.naturalWidth>4096||img.naturalHeight>4096;warn=warn||tooBig;if(warn)status('Large image ‚Äî compressing to fit‚Ä¶',2500);let max=1600;let quality=0.86;let data;for(let attempts=0;attempts<3;attempts++){data=await drawToDataURL(img,max,max,'image/webp',quality);if(data.length<1.5*1024*1024)break;quality-=0.12;max-=200;}URL.revokeObjectURL(img.src);return data;}
    function drawToDataURL(img,maxW,maxH,mime,quality){return new Promise((resolve)=>{const r=Math.min(maxW/img.naturalWidth,maxH/img.naturalHeight,1);const w=Math.round(img.naturalWidth*r),h=Math.round(img.naturalHeight*r);const c=document.createElement('canvas');c.width=w;c.height=h;const ctx=c.getContext('2d');ctx.drawImage(img,0,0,w,h);resolve(c.toDataURL(mime,quality));});}

    async function saveAll(){await Promise.all([idbSet(IDB_KEYS.meals,state.meals),idbSet(IDB_KEYS.normaliser,state.normaliser),idbSet(IDB_KEYS.unitDefaults,state.unitDefaults),idbSet(IDB_KEYS.prefs,state.prefs)]);}    
    async function loadAll(){
      const [meals,normaliser,unitDefaults,prefs]=await Promise.all([idbGet(IDB_KEYS.meals),idbGet(IDB_KEYS.normaliser),idbGet(IDB_KEYS.unitDefaults),idbGet(IDB_KEYS.prefs)]);
      if(Array.isArray(meals)) state.meals = meals.map(m=>({fav:false,tags:[],steps:[],notes:'',...m}));
      state.normaliser=Array.isArray(normaliser)?normaliser:[];
      state.unitDefaults=(unitDefaults&&typeof unitDefaults==='object')?unitDefaults:{};
      state.prefs=(prefs&&typeof prefs==='object')?{theme:'auto',gridMin:'cozy',includeIngredientTags:false,tagStripMax:12,...prefs}:{theme:'auto',gridMin:'cozy',includeIngredientTags:false,tagStripMax:12};
    }
    function saveSelection(){sessionStorage.setItem('sel-v7',JSON.stringify(Array.from(state.selected)));}
    function loadSelection(){try{const raw=sessionStorage.getItem('sel-v7');if(raw)state.selected=new Set(JSON.parse(raw));}catch{}}

    function applyTheme(){let mode=state.prefs.theme;if(mode==='auto'){mode=window.matchMedia&&window.matchMedia('(prefers-color-scheme: light)').matches?'light':'dark';}document.documentElement.setAttribute('data-theme',mode==='light'?'light':'dark');$('#theme-toggle').textContent=mode==='light'?'‚òÄÔ∏è':'üåô';}
    $('#theme-toggle').addEventListener('click',async()=>{const current=document.documentElement.getAttribute('data-theme')==='light'?'light':'dark';state.prefs.theme=current==='light'?'dark':'light';applyTheme();await saveAll();});

    function updateIngredientSuggestions(){const set=new Set();state.meals.forEach(m=>m.ingredients.forEach(i=>set.add(normaliseRaw(i.name))));const list=$('#ingredient-suggestions');list.innerHTML='';Array.from(set).sort().forEach(n=>{const o=document.createElement('option');o.value=n;list.appendChild(o);});}
    function allTagsSet(){const s=new Set();state.meals.forEach(m=>(m.tags||[]).forEach(t=>s.add(String(t).toLowerCase())));return s;}
    function refreshTagSuggestions(){const list=$('#tag-suggestions');list.innerHTML='';Array.from(allTagsSet()).sort().forEach(t=>{const o=document.createElement('option');o.value=t;list.appendChild(o);});}

    function addIngredientRow(container,pref={}){
      const row=$('#ingredient-template').content.firstElementChild.cloneNode(true);
      const [nameEl,typeEl,amtEl,unitEl,rm]=row.children;
      nameEl.value=pref.name||'';nameEl.setAttribute('list','ingredient-suggestions');
      typeEl.value=pref.type||'grams';
      amtEl.value=pref.amount??'';
      unitEl.value=pref.unit||'';
      function enforce(){
        if(typeEl.value==='qty'){
          amtEl.step='1';
          if(amtEl.value) amtEl.value=String(Math.max(0,Math.round(parseFloat(amtEl.value)||0)));
        } else {
          amtEl.step='any';
        }
      }
      enforce();
      typeEl.addEventListener('change',enforce);
      rm.addEventListener('click',()=>row.remove());
      nameEl.addEventListener('change',()=>maybeApplyUnitDefault(row));
      nameEl.addEventListener('blur',()=>maybeSuggestNormalisation(row));
      container.appendChild(row);
      if(nameEl.value) maybeApplyUnitDefault(row);
    }

    function maybeApplyUnitDefault(row){
      const [nameEl,typeEl,amtEl,unitEl]=row.children;
      const key=normaliseKey(nameEl.value);
      const def=state.unitDefaults[key];
      const locked=def?.locked;
      if(def){
        typeEl.value=def.type;
        if(def.unitLabel) unitEl.value=def.unitLabel;
      }
      typeEl.disabled=!!locked;
      unitEl.disabled=!!locked&&def?.type==='qty';
      typeEl.title=locked?'Locked by unit defaults (Settings)':'';
      unitEl.title=typeEl.title;
      typeEl.addEventListener('change',()=>maybeUpdateDefaultPrompt(key,typeEl,unitEl));
      unitEl.addEventListener('change',()=>maybeUpdateDefaultPrompt(key,typeEl,unitEl));
    }

    function maybeUpdateDefaultPrompt(key,typeEl,unitEl){
      const name=key;
      if(!name) return;
      const cur=state.unitDefaults[key];
      const next={type:typeEl.value,unitLabel:unitEl.value||undefined,locked:!!cur?.locked};
      if(!cur||cur.type!==next.type||(cur.unitLabel||'')!==(next.unitLabel||'')){
        if(confirm(`Update default unit for "${name}"?`)){
          state.unitDefaults[key]=next;
          saveAll();
          renderSettings();
        }
      }
    }

    function normaliserLookup(name){
      const key=normaliseKey(name);
      const singular=singularise(key);
      for(const e of state.normaliser){
        const ck=normaliseKey(e.canonical);
        if(key===ck||singular===normaliseKey(e.canonical)) return e.canonical;
        for(const a of e.aliases||[]){
          const ak=normaliseKey(a);
          if(key===ak||singular===ak) return e.canonical;
        }
      }
      return null;
    }

    function maybeSuggestNormalisation(row){
      const [nameEl]=row.children;
      const raw=nameEl.value.trim();
      if(!raw) return;
      const canonical=normaliserLookup(raw);
      if(!canonical){
        const k=normaliseKey(raw),ks=singularise(k);
        const hit=state.normaliser.find(e=>normaliseKey(e.canonical)===ks);
        if(!hit) return;
        return showNormPrompt(row,raw,hit.canonical);
      }
      if(canonical&&canonical!==raw.toLowerCase()) showNormPrompt(row,raw,canonical);
    }

    function showNormPrompt(row,from,to){
      let prompt=row.nextElementSibling;
      if(!prompt||!prompt.classList||!prompt.classList.contains('norm-prompt')){
        prompt=document.createElement('div');
        prompt.className='norm-prompt';
        prompt.style.cssText='margin:-6px 0 6px; color:var(--muted); font-size:.85rem;';
        row.after(prompt);
      }
      prompt.innerHTML=`Merge "${escapeHtml(from)}" into <b>${escapeHtml(to)}</b>? <button class="btn" style="padding:4px 8px">Merge</button> <button class="btn" style="padding:4px 8px">Keep</button> <label style="margin-left:6px"><input type="checkbox"/> also update existing meals</label>`;
      const [mergeBtn,keepBtn,label]=prompt.querySelectorAll('button,button,label');
      mergeBtn.addEventListener('click',()=>{
        const [nameEl]=row.children;
        nameEl.value=to;
        prompt.remove();
        if(label.querySelector('input').checked){
          const fromKey=normaliseKey(from),toKey=normaliseKey(to);
          for(const meal of state.meals){
            for(const ing of meal.ingredients){
              if(normaliseKey(ing.name)===fromKey){
                ing.name=toKey;
              }
            }
          }
          saveAll();
          renderMeals();
          renderShopping();
          updateIngredientSuggestions();
        }
      }, {once:true});
      keepBtn.addEventListener('click',()=>prompt.remove(),{once:true});
    }

    function tokenEditor(container,input,initial=[]){
      container.innerHTML='';
      const tokens=new Set(initial.map(t=>t.toLowerCase()));
      function render(){
        container.innerHTML='';
        tokens.forEach(t=>{
          const chip=document.createElement('span');
          chip.className='chip';
          chip.textContent=t;
          const x=document.createElement('button');
          x.textContent='√ó';
          x.className='btn';
          x.style.padding='2px 6px';
          x.addEventListener('click',()=>{tokens.delete(t);render();});
          const wrap=document.createElement('span');
          wrap.className='group';
          wrap.style.gap='6px';
          wrap.append(chip,x);
          container.appendChild(wrap);
        });
      }
      function addToken(v){
        v=v.trim();
        if(!v) return;
        v=v.toLowerCase();
        tokens.add(v);
        render();
        input.value='';
      }
      input.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===','){e.preventDefault();addToken(input.value.replace(/,$/,''));}});
      input.addEventListener('change',()=>addToken(input.value));
      render();
      return{get:()=>Array.from(tokens),set:(arr)=>{arr=(arr||[]).map(x=>x.toLowerCase());tokens.clear();arr.forEach(x=>tokens.add(x));render();}, addMany:(arr)=>{arr.forEach(x=>tokens.add(x.toLowerCase()));render();}};
    }

    function ingredientNamesToTags(ings){
      const out=new Set();
      ings.forEach(i=>{
        const raw=normaliseRaw(i.name);
        const canon=normaliserLookup(raw)||raw;
        out.add(canon);
      });
      return Array.from(out);
    }

    // ===== Steps helpers =====
    function renderSteps(container, steps, onChange){
      container.innerHTML='';
      if(!steps.length){
        const d=document.createElement('div');
        d.className='empty';
        d.textContent='No steps yet.';
        container.appendChild(d);
        return;
      }
      steps.forEach((text, idx)=>{
        const row=document.createElement('div');
        row.className='step-row';

        const t=document.createElement('div');
        t.className='step-text';
        t.textContent=`${idx+1}. ${text}`;

        const up=document.createElement('button');
        up.className='btn mini';
        up.type='button';
        up.textContent='‚Üë';
        up.disabled = idx===0;
        up.addEventListener('click',()=>{
          const tmp=steps[idx-1]; steps[idx-1]=steps[idx]; steps[idx]=tmp;
          onChange();
        });

        const down=document.createElement('button');
        down.className='btn mini';
        down.type='button';
        down.textContent='‚Üì';
        down.disabled = idx===steps.length-1;
        down.addEventListener('click',()=>{
          const tmp=steps[idx+1]; steps[idx+1]=steps[idx]; steps[idx]=tmp;
          onChange();
        });

        const del=document.createElement('button');
        del.className='btn danger mini';
        del.type='button';
        del.textContent='√ó';
        del.addEventListener('click',()=>{
          steps.splice(idx,1);
          onChange();
        });

        row.append(t, up, down, del);
        container.appendChild(row);
      });
    }

    function addStepFromInput(inputEl, steps, onChange){
      const v=(inputEl.value||'').trim();
      if(!v) return;
      steps.push(v);
      inputEl.value='';
      onChange();
    }

    // ===== Modals helpers =====
    function lockBodyScroll(locked){
      if(locked) document.body.classList.add('modal-open');
      else document.body.classList.remove('modal-open');
    }

    const ingContainer=$('#ingredients');
    $('#add-ingredient').addEventListener('click',()=>addIngredientRow(ingContainer));
    addIngredientRow(ingContainer);addIngredientRow(ingContainer);
    const tagEditor=tokenEditor($('#tags-editor'),$('#tags-input'));

    // Create steps state
    let createSteps=[];
    function refreshCreateSteps(){ renderSteps($('#steps'), createSteps, refreshCreateSteps); }
    $('#add-step').addEventListener('click',()=>addStepFromInput($('#step-input'), createSteps, refreshCreateSteps));
    $('#step-input').addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); addStepFromInput($('#step-input'), createSteps, refreshCreateSteps); }});
    refreshCreateSteps();

    $('#meal-form').addEventListener('submit',async(e)=>{
      e.preventDefault();
      const title=$('#title').value.trim();
      if(!title){alert('Please provide a title.');return;}

      const file=$('#image-file').files[0];
      const imageDataUrl=await fileToCompressedDataURL(file);

      const cookMinsRaw=$('#cook-mins').value.trim();
      let cookMins=Number(cookMinsRaw);
      if(!isFinite(cookMins)) cookMins=null;
      if(cookMins<0) cookMins=0;
      if(cookMins>120) cookMins=120;

      const ingredients=[];
      $$('.ingredient-row',ingContainer).forEach(row=>{
        const [nEl,tEl,aEl,uEl]=row.children;
        const name=nEl.value.trim();
        if(!name) return;
        let amount=Number(aEl.value);
        if(!isFinite(amount)||amount<0) return;
        const type=tEl.value;
        if(type==='qty') amount=Math.max(0,Math.round(amount));
        const unit=uEl.value.trim();
        ingredients.push({name:normaliseRaw(name),type,amount,unit});
      });
      if(!ingredients.length){alert('Please add at least one valid ingredient.');return;}

      const autoTags=ingredientNamesToTags(ingredients);
      const userTags=tagEditor.get();
      const tags=Array.from(new Set([...userTags,...autoTags]));

      const steps = createSteps.slice();
      const notes = ($('#notes').value || '').trim();

      const meal={
        id:uid(),
        title,
        image:imageDataUrl?{type:'data',src:imageDataUrl}:null,
        fav:false,
        tags,
        ingredients,
        cookMins:cookMins||null,
        steps,
        notes
      };

      state.meals.unshift(meal);
      await saveAll();
      renderMeals();
      renderShopping();
      updateIngredientSuggestions();
      refreshTagSuggestions();

      e.target.reset();
      ingContainer.innerHTML='';
      addIngredientRow(ingContainer);addIngredientRow(ingContainer);
      tagEditor.set([]);
      createSteps=[];
      refreshCreateSteps();
      $('#notes').value='';
      status('Meal added.');
    });

    $('#reset-form').addEventListener('click',()=>{
      ingContainer.innerHTML='';
      addIngredientRow(ingContainer);addIngredientRow(ingContainer);
      tagEditor.set([]);
      createSteps=[];
      refreshCreateSteps();
      $('#notes').value='';
    });

    $('#duplicate-last').addEventListener('click',async()=>{
      if(!state.meals.length) return;
      const copy=JSON.parse(JSON.stringify(state.meals[0]));
      copy.id=uid();
      copy.title+=' (copy)';
      state.meals.unshift(copy);
      await saveAll();
      renderMeals();
      status('Duplicated last meal.');
    });

    // ===== Edit modal =====
    const modal=$('#edit-modal');
    const editIng=$('#edit-ingredients');
    const editTagEditor=tokenEditor($('#edit-tags-editor'),$('#edit-tags-input'));

    let editSteps=[];
    function refreshEditSteps(){ renderSteps($('#edit-steps'), editSteps, refreshEditSteps); }
    $('#edit-add-step').addEventListener('click',()=>addStepFromInput($('#edit-step-input'), editSteps, refreshEditSteps));
    $('#edit-step-input').addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); addStepFromInput($('#edit-step-input'), editSteps, refreshEditSteps); }});
    refreshEditSteps();

    function openEdit(id){
      const meal=state.meals.find(m=>m.id===id);
      if(!meal) return;
      state.editingId=id;
      $('#edit-title').value=meal.title;
      $('#edit-cook-mins').value=meal.cookMins??'';
      editIng.innerHTML='';
      meal.ingredients.forEach(i=>addIngredientRow(editIng,i));
      editTagEditor.set(meal.tags||[]);
      editSteps = Array.isArray(meal.steps) ? meal.steps.slice() : [];
      refreshEditSteps();
      $('#edit-notes').value = meal.notes || '';
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
      lockBodyScroll(true);
      setTimeout(()=>$('#edit-title')?.focus(), 40);
    }

    function closeEdit(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      state.editingId=null;
      $('#edit-form').reset();
      editIng.innerHTML='';
      editSteps=[];
      refreshEditSteps();
      $('#edit-notes').value='';
      lockBodyScroll(false);
    }

    $('#edit-close').addEventListener('click',closeEdit);
    $('#edit-cancel').addEventListener('click',closeEdit);
    $('#edit-add-ingredient').addEventListener('click',()=>addIngredientRow(editIng));

    $('#edit-tags-from-ingredients').addEventListener('click',()=>{
      const ings=[];
      $$('.ingredient-row',editIng).forEach(row=>{
        const [n]=row.children;
        const name=n.value.trim();
        if(name) ings.push({name});
      });
      editTagEditor.addMany(ingredientNamesToTags(ings));
    });

    $('#edit-form').addEventListener('submit',async(e)=>{
      e.preventDefault();
      const meal=state.meals.find(m=>m.id===state.editingId);
      if(!meal) return;

      meal.title=$('#edit-title').value.trim()||meal.title;

      const f=$('#edit-image-file').files[0];
      if(f){
        const data=await fileToCompressedDataURL(f);
        if(data) meal.image={type:'data',src:data};
      }

      const cookRaw=$('#edit-cook-mins').value.trim();
      let cook=Number(cookRaw);
      if(!isFinite(cook)) cook=null;
      if(cook<0) cook=0;
      if(cook>120) cook=120;
      meal.cookMins=cook;

      const ing=[];
      $$('.ingredient-row',editIng).forEach(row=>{
        const [n,t,a,u]=row.children;
        const name=n.value.trim();
        if(!name) return;
        let amount=Number(a.value);
        if(!isFinite(amount)||amount<0) return;
        const type=t.value;
        if(type==='qty') amount=Math.max(0,Math.round(amount));
        const unit=u.value.trim();
        ing.push({name:normaliseRaw(name),type,amount,unit});
      });
      if(!ing.length){alert('Please add at least one ingredient.');return;}
      meal.ingredients=ing;
      meal.tags=editTagEditor.get();
      meal.steps = editSteps.slice();
      meal.notes = ($('#edit-notes').value || '').trim();

      await saveAll();
      renderMeals();
      renderShopping();
      updateIngredientSuggestions();
      refreshTagSuggestions();
      closeEdit();
      status('Meal updated.');
    });

    // Close modals with Escape
    window.addEventListener('keydown',(e)=>{
      if(e.key!=='Escape') return;
      if($('#settings-modal').classList.contains('open')) closeSettings();
      if(modal.classList.contains('open')) closeEdit();
    });

    // ==== Tag bar: counts + top N + popover ====
    function computeTagStats(){
      const counts=new Map();
      const ingNames=new Set();
      state.meals.forEach(m=>m.ingredients.forEach(i=>ingNames.add(normaliseRaw(i.name))));
      state.meals.forEach(m=> (m.tags||[]).forEach(t=>{const k=String(t).toLowerCase();counts.set(k,(counts.get(k)||0)+1);}));
      const rows=Array.from(counts.entries()).map(([tag,count])=>({tag,count,isIngredient:ingNames.has(tag)}));
      rows.sort((a,b)=> b.count-a.count || a.tag.localeCompare(b.tag));
      const noTagsCount=state.meals.filter(m=>!m.tags||m.tags.length===0).length;
      return {rows,noTagsCount};
    }

    function pruneTagFilter(){
      const all=allTagsSet();
      for(const t of Array.from(state.tagFilter)){
        if(t===NO_TAGS) continue;
        if(!all.has(t)) state.tagFilter.delete(t);
      }
      if(!state.tagFilter.size){
        state.tagMode='ANY';
      }
    }

    function buildTagBar(){
      pruneTagFilter();
      const bar=$('#tag-bar');
      bar.innerHTML='';
      const {rows}=computeTagStats();
      const includeIng=!!state.prefs.includeIngredientTags;
      const max=Number(state.prefs.tagStripMax)||12;
      const active=Array.from(state.tagFilter).filter(t=>t!==NO_TAGS);

      const list=[];
      active.forEach(t=>{if(!list.find(x=>x.tag===t)) list.push({tag:t,count:rows.find(r=>r.tag===t)?.count||0});});
      rows.forEach(r=>{if(!includeIng && r.isIngredient) return; if(!list.find(x=>x.tag===r.tag)) list.push({tag:r.tag,count:r.count});});

      const extra=list.length>max?list.length-max:0;
      const show=list.slice(0,max);

      function chip(label,isActive,count){
        const b=document.createElement('button');
        b.className='tag';
        if(isActive) b.classList.add('active');
        b.innerHTML=`${escapeHtml(label)}${count?` <span class="count">${count}</span>`:''}`;
        b.addEventListener('click',()=>{toggleTag(label);});
        return b;
      }
      function toggleTag(tag){
        if(state.tagFilter.has(tag)) state.tagFilter.delete(tag);
        else state.tagFilter.add(tag);
        renderMeals();
        buildTagBar();
      }

      show.forEach(x=>bar.appendChild(chip(x.tag,state.tagFilter.has(x.tag),x.count)));
      if(extra>0){
        const more=document.createElement('button');
        more.className='tag';
        more.textContent=`+ ${extra} more`;
        more.addEventListener('click',(ev)=>openTagPopover(ev.currentTarget));
        bar.appendChild(more);
      }

      const hiddenActive=active.filter(t=>!show.find(x=>x.tag===t));
      if(hiddenActive.length){
        const act=document.createElement('span');
        act.className='muted';
        act.textContent=`${hiddenActive.length} hidden active`;
        bar.appendChild(act);
      }

      const mode=state.tagMode==='ALL'?'ALL':'ANY';
      $('#tag-active').textContent = state.tagFilter.size? `${state.tagFilter.size} selected (${mode})` : '';
    }

    function openTagPopover(anchor){
      closePopover();
      const {rows,noTagsCount}=computeTagStats();
      const incIng=!!state.prefs.includeIngredientTags;
      const rect=anchor.getBoundingClientRect();
      const p=document.createElement('div');
      p.className='popover';
      p.style.top=(rect.bottom+8)+'px';
      p.style.left=Math.max(10,Math.min(window.innerWidth-520,rect.left))+'px';
      p.innerHTML=`
        <div class='pop-title'>Filter by tag</div>
        <div class='pop-row'>
          <input id='tag-search' type='text' placeholder='Search tags‚Ä¶' style='flex:1; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:var(--card); color:var(--text)'>
          <button class='btn' id='tag-mode-toggle' style='white-space:nowrap'>Mode: ${state.tagMode}</button>
        </div>
        <label class='pop-row' style='user-select:none'><input id='toggle-ingredient-tags' type='checkbox' ${incIng?'checked':''}/> Include ingredient tags</label>
        <div class='pop-sub'>Select tags</div>
        <div class='pop-list' id='tag-list'></div>
        <div class='pop-row' style='justify-content:space-between'>
          <button class='btn' id='clear-tags'>Clear</button>
          <button class='btn' id='close-tags'>Done</button>
        </div>`;
      document.body.appendChild(p);
      popEl=p;
      setTimeout(()=>window.addEventListener('click',closePopover),0);

      const listEl=$('#tag-list',p);
      function renderList(){
        const q=$('#tag-search',p).value.trim().toLowerCase();
        listEl.innerHTML='';
        const sentinel={tag:NO_TAGS,label:'no tags',count:noTagsCount};
        const candidates = rows.filter(r=> incIng || !r.isIngredient );
        const items=[sentinel, ...candidates.map(r=>({tag:r.tag,label:r.tag,count:r.count}))].filter(x=>!q || x.label.includes(q));
        items.forEach(x=>{
          const b=document.createElement('div');
          b.className='pop-chip';
          if(state.tagFilter.has(x.tag)) b.classList.add('active');
          b.innerHTML=`<input type='checkbox' ${state.tagFilter.has(x.tag)?'checked':''}/> ${escapeHtml(x.label)} <span class='count' style='margin-left:auto'>${x.count}</span>`;
          const cb=b.querySelector('input');
          b.addEventListener('click',(ev)=>{
            if(ev.target.tagName!=='INPUT') cb.checked=!cb.checked;
            if(cb.checked) state.tagFilter.add(x.tag); else state.tagFilter.delete(x.tag);
            buildTagBar(); renderMeals();
          });
          cb.addEventListener('change',()=>{ if(cb.checked) state.tagFilter.add(x.tag); else state.tagFilter.delete(x.tag); buildTagBar(); renderMeals(); });
          listEl.appendChild(b);
        });
      }

      $('#tag-search',p).addEventListener('input',renderList);
      $('#tag-mode-toggle',p).addEventListener('click',()=>{ state.tagMode= state.tagMode==='ANY'?'ALL':'ANY'; $('#tag-mode-toggle',p).textContent=`Mode: ${state.tagMode}`; renderMeals(); buildTagBar(); });
      $('#toggle-ingredient-tags',p).addEventListener('change',async(e)=>{ state.prefs.includeIngredientTags=!!e.target.checked; await saveAll(); buildTagBar(); renderList(); });
      $('#clear-tags',p).addEventListener('click',()=>{ state.tagFilter.clear(); buildTagBar(); renderMeals(); renderList(); });
      $('#close-tags',p).addEventListener('click',closePopover);

      renderList();
    }

    // ====== Card grid ======
    const grid=$('#meal-grid');

    function visibleMeals(){
      let items=[...state.meals];
      if(state.showFavsOnly) items=items.filter(m=>m.fav);
      if(state.search) items=items.filter(m=>(m.title||'').toLowerCase().includes(state.search));
      if(state.tagFilter.size){
        const need=[...state.tagFilter];
        items=items.filter(m=>{
          const hasNoTags = !m.tags || m.tags.length===0;
          const tags=new Set((m.tags||[]).map(t=>String(t).toLowerCase()));
          if(state.tagMode==='ANY') return need.some(t=> t===NO_TAGS?hasNoTags:tags.has(t));
          return need.every(t=> t===NO_TAGS?hasNoTags:tags.has(t));
        });
      }
      // time filter
      items = items.filter(m=>{ const t=m.cookMins; if(typeof t!=='number') return (state.timeFilter.min===0 && state.timeFilter.max===120); return t>=state.timeFilter.min && t<=state.timeFilter.max; });
      return items.sort((a,b)=>{const fav=(b.fav===true)-(a.fav===true); if(fav) return fav; return (a.title||'').localeCompare(b.title||'','en-GB',{sensitivity:'base'});});
    }

    function renderMeals(){
      buildTagBar();
      grid.innerHTML='';
      const items=visibleMeals();
      if(!items.length){
        const d=document.createElement('div');
        d.className='empty';
        d.textContent='No meals match your filters.';
        grid.appendChild(d);
        return;
      }

      items.forEach(meal=>{
        const card=document.createElement('div');
        card.className='card';

        const media=document.createElement('div');
        media.className='media';

        const img=document.createElement('img');
        img.alt=meal.title;
        img.loading='lazy';
        img.decoding='async';
        img.src=meal.image?.src||placeholderSvg(meal.title);
        img.addEventListener('load',()=>img.classList.add('ready'));

        const sel=document.createElement('label');
        sel.className='select';
        const cb=document.createElement('input');
        cb.type='checkbox';
        cb.checked=state.selected.has(meal.id);
        cb.addEventListener('change',()=>{
          if(cb.checked) state.selected.add(meal.id);
          else state.selected.delete(meal.id);
          renderShopping();
          saveSelection();
        });
        sel.append(cb,document.createTextNode(' Include'));

        const fav=document.createElement('button');
        fav.className='fav';
        fav.dataset.on=meal.fav?'true':'false';
        const star=document.createElement('span');
        star.textContent=meal.fav?'‚òÖ':'‚òÜ';
        const ft=document.createElement('span');
        ft.textContent=meal.fav?'Favourited':'Favourite';
        fav.append(star,ft);
        fav.addEventListener('click',async()=>{const m=state.meals.find(x=>x.id===meal.id);m.fav=!m.fav;await saveAll();renderMeals();});

        media.append(img,sel,fav);

        const title=document.createElement('h3');
        title.textContent=meal.title;

        const chips=document.createElement('div');
        chips.className='chips';
        if(typeof meal.cookMins==='number'){
          const t=document.createElement('span');
          t.className='chip';
          t.textContent=`‚è± ${meal.cookMins} min`;
          chips.appendChild(t);
        }
        if(Array.isArray(meal.steps) && meal.steps.length){
          const s=document.createElement('span');
          s.className='chip';
          s.textContent=`üßæ ${meal.steps.length} step${meal.steps.length===1?'':'s'}`;
          chips.appendChild(s);
        }
        if(meal.notes && String(meal.notes).trim()){
          const n=document.createElement('span');
          n.className='chip';
          n.textContent='üìù notes';
          chips.appendChild(n);
        }

        const body=document.createElement('div');
        body.append(title,chips);

        if(!meal.tags || !meal.tags.length){
          const nt=document.createElement('div');
          nt.className='no-tags';
          nt.textContent='no tags';
          nt.title='Click to add tags';
          nt.addEventListener('click',()=>{ openEdit(meal.id); setTimeout(()=>$('#edit-tags-input')?.focus(), 80); });
          body.appendChild(nt);
        }

        const controls=document.createElement('div');
        controls.className='controls';
        const editBtn=document.createElement('button');
        editBtn.className='btn';
        editBtn.textContent='Edit';
        editBtn.addEventListener('click',()=>openEdit(meal.id));
        const del=document.createElement('button');
        del.className='btn danger';
        del.textContent='Delete';
        del.addEventListener('click',async()=>{
          if(!confirm(`Delete ‚Äú${meal.title}‚Äù?`)) return;
          state.meals=state.meals.filter(m=>m.id!==meal.id);
          state.selected.delete(meal.id);
          await saveAll();
          renderMeals();
          renderShopping();
          updateIngredientSuggestions();
          refreshTagSuggestions();
          status('Meal deleted.');
        });
        controls.append(editBtn,del);
        body.appendChild(controls);

        card.append(media,body);
        grid.appendChild(card);
      });
    }

    // ===== Popover helpers (reuse) =====
    let popEl=null;
    function closePopover(){
      if(popEl){
        popEl.remove();
        popEl=null;
        window.removeEventListener('click',closePopover);
      }
    }

    $$('[data-density]').forEach(btn=>btn.addEventListener('click',()=>{
      const mode=btn.dataset.density;
      document.documentElement.style.setProperty('--card-min',mode==='compact'?'200px':mode==='cozy'?'260px':'320px');
      state.prefs.gridMin=mode;
      saveAll();
      renderMeals();
    }));

    $('#toggle-favs').addEventListener('click',()=>{
      state.showFavsOnly=!state.showFavsOnly;
      $('#toggle-favs').textContent=state.showFavsOnly?'Show all':'Show favourites only';
      renderMeals();
    });

    // Search
    $('#search').addEventListener('input',(e)=>{ state.search=(e.target.value||'').trim().toLowerCase(); renderMeals(); });

    // Time filter
    function clampTime(){
      const minEl=$('#time-min');
      const maxEl=$('#time-max');
      let a=Number(minEl.value), b=Number(maxEl.value);
      if(a>b){ const tmp=a; a=b; b=tmp; }
      state.timeFilter.min=a; state.timeFilter.max=b;
      $('#time-label').textContent = `${a}‚Äì${b} min`;
    }
    $('#time-min').addEventListener('input',()=>{ clampTime(); renderMeals(); });
    $('#time-max').addEventListener('input',()=>{ clampTime(); renderMeals(); });
    $('#time-clear').addEventListener('click',(e)=>{ e.preventDefault(); $('#time-min').value='0'; $('#time-max').value='120'; clampTime(); renderMeals(); });
    clampTime();

    // ===== Shopping list =====
    const shoppingWrap=$('#shopping');
    function aggKey(i){
      if(i.type==='grams') return `${normaliseRaw(i.name)}|g`;
      if(i.type==='ml') return `${normaliseRaw(i.name)}|ml`;
      if(['tsp','tbsp','cup'].includes(i.type)) return `${normaliseRaw(i.name)}|${i.type}`;
      return `${normaliseRaw(i.name)}|qty|${(i.unit||'').toLowerCase()}`;
    }

    function aggregate(){
      const sel=state.meals.filter(m=>state.selected.has(m.id));
      const map=new Map();
      for(const m of sel){
        for(const i of (m.ingredients||[])){
          const k=aggKey(i);
          const p=map.get(k)||{name:i.name,type:i.type,unit:i.unit,total:0};
          p.total+=Number(i.amount)||0;
          map.set(k,p);
        }
      }
      return Array.from(map.values()).sort((a,b)=>a.name.localeCompare(b.name,'en-GB',{sensitivity:'base'}));
    }

    function displayValueAndUnit(r){
      if(r.type==='ml'){
        if(r.total>=1000) return{value:r.total/1000,unit:'L'};
        return{value:r.total,unit:'ml'};
      }
      if(r.type==='grams') return{value:r.total,unit:'g'};
      if(['tsp','tbsp','cup'].includes(r.type)) return{value:r.total,unit:r.type};
      return{value:r.total,unit:(r.unit||'qty')};
    }

    function renderShopping(){
      shoppingWrap.innerHTML='';
      const rows=aggregate();
      if(!rows.length){
        const d=document.createElement('div');
        d.className='empty';
        d.textContent='Select meals to build your shopping list.';
        shoppingWrap.appendChild(d);
        return;
      }
      const table=document.createElement('table');
      const thead=document.createElement('thead');
      thead.innerHTML='<tr><th>Ingredient</th><th>Total</th><th>Unit</th></tr>';
      const tbody=document.createElement('tbody');
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        const {value,unit}=displayValueAndUnit(r);
        tr.innerHTML=`<td>${escapeHtml(titleCase(r.name))}</td><td>${formatNumber(value)}</td><td>${escapeHtml(unit)}</td>`;
        tbody.appendChild(tr);
      });
      const tfoot=document.createElement('tfoot');
      const totals={
        grams:rows.filter(r=>r.type==='grams').reduce((s,r)=>s+r.total,0),
        ml:rows.filter(r=>r.type==='ml').reduce((s,r)=>s+r.total,0),
        tsp:rows.filter(r=>r.type==='tsp').reduce((s,r)=>s+r.total,0),
        tbsp:rows.filter(r=>r.type==='tbsp').reduce((s,r)=>s+r.total,0),
        cup:rows.filter(r=>r.type==='cup').reduce((s,r)=>s+r.total,0),
        qty:rows.filter(r=>r.type==='qty').reduce((s,r)=>s+r.total,0)
      };
      const mlDisp=totals.ml>=1000?`${formatNumber(totals.ml/1000)} L`:`${formatNumber(totals.ml)} ml`;
      tfoot.innerHTML=`<tr><td colspan="3">Totals ‚Äî Weight: ${formatNumber(totals.grams)} g, Volume: ${mlDisp}, tsp: ${formatNumber(totals.tsp)}, tbsp: ${formatNumber(totals.tbsp)}, cup: ${formatNumber(totals.cup)}, Quantity: ${formatNumber(totals.qty)}</td></tr>`;
      table.append(thead,tbody,tfoot);
      shoppingWrap.appendChild(table);
    }

    $('#copy-tsv').addEventListener('click',()=>{
      const rows=aggregate();
      if(!rows.length) return alert('No items to copy.');
      const header=['Ingredient','Total','Unit'];
      const body=rows.map(r=>{const {value,unit}=displayValueAndUnit(r);return[titleCase(r.name),String(value),unit];});
      const tsv=[[...header],...body].map(cols=>cols.map(v=>String(v).replaceAll('\t',' ')).join('\t')).join('\n');
      navigator.clipboard.writeText(tsv).then(()=>status('Shopping list copied (TSV).'));
    });

    $('#print').addEventListener('click',()=>window.print());

    // Export current data
    $('#export').addEventListener('click',()=>{
      const data=JSON.stringify({schemaVersion:EXPORT_SCHEMA_VERSION,meals:state.meals,normaliser:state.normaliser,unitDefaults:state.unitDefaults,prefs:state.prefs},null,2);
      const blob=new Blob([data],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download=`meal-planner-export-v${EXPORT_SCHEMA_VERSION}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // Import data (with migration)
    $('#import').addEventListener('change',async(e)=>{
      const f=e.target.files[0];
      if(!f) return;
      try{
        const json=JSON.parse(await f.text());
        const migrated=migrateImport(json);
        if(!migrated) throw new Error('Invalid file');
        state.meals=migrated.meals;
        state.normaliser=migrated.normaliser||[];
        state.unitDefaults=migrated.unitDefaults||{};
        state.prefs=migrated.prefs||state.prefs;
        state.selected.clear();
        await saveAll();
        renderMeals();
        renderShopping();
        updateIngredientSuggestions();
        refreshTagSuggestions();
        status('Imported.');
      }catch{
        alert('Import failed. Expecting a file exported by this app.');
      }finally{
        e.target.value='';
      }
    });

    // Clear all
    $('#clear-all').addEventListener('click',async()=>{
      if(!confirm('Delete ALL saved meals?')) return;
      state.meals=[];
      state.selected.clear();
      await saveAll();
      renderMeals();
      renderShopping();
      updateIngredientSuggestions();
      refreshTagSuggestions();
    });

    function migrateImport(json){
      if(!json) return null;
      if(Array.isArray(json.meals)){
        const meals=json.meals.map(m=>{
          const clone={
            fav:false,
            tags:[],
            cookMins:(typeof m.cookMins==='number')?m.cookMins:null,
            steps:Array.isArray(m.steps)?m.steps.map(x=>String(x)) : [],
            notes:(typeof m.notes==='string')?m.notes : '',
            ...m
          };
          if(clone.imageDataUrl){
            clone.image={type:'data',src:clone.imageDataUrl};
            delete clone.imageDataUrl;
          }
          // Optional bridge: older exports with string instructions
          if(!clone.steps.length && typeof clone.instructions==='string' && clone.instructions.trim()){
            clone.steps = clone.instructions.split('\n').map(s=>s.trim()).filter(Boolean);
          }
          return clone;
        });
        return {
          meals,
          normaliser: json.normaliser||[],
          unitDefaults: json.unitDefaults||{},
          prefs: json.prefs||{ theme:'auto', gridMin:'cozy', includeIngredientTags:false, tagStripMax:12 }
        };
      }
      return null;
    }

    // ===== Settings modal =====
    const settingsModal=$('#settings-modal');

    function openSettings(){
      renderSettings();
      settingsModal.classList.add('open');
      settingsModal.setAttribute('aria-hidden','false');
      lockBodyScroll(true);
    }

    function closeSettings(){
      settingsModal.classList.remove('open');
      settingsModal.setAttribute('aria-hidden','true');
      lockBodyScroll(false);
    }

    $('#settings').addEventListener('click',openSettings);
    $('#settings-close').addEventListener('click',closeSettings);

    function renderSettings(){
      const nt=$('#norm-table tbody');
      nt.innerHTML='';
      state.normaliser.forEach((e,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${escapeHtml(e.canonical)}</td><td>${escapeHtml((e.aliases||[]).join(', '))}</td><td><button class='btn' data-del-norm='${idx}'>Delete</button></td>`;
        nt.appendChild(tr);
      });
      nt.querySelectorAll('[data-del-norm]').forEach(b=>b.addEventListener('click',async ev=>{
        const i=Number(ev.currentTarget.getAttribute('data-del-norm'));
        state.normaliser.splice(i,1);
        await saveAll();
        renderSettings();
      }));

      const ut=$('#unit-table tbody');
      ut.innerHTML='';
      Object.entries(state.unitDefaults).sort(([a],[b])=>a.localeCompare(b)).forEach(([name,def])=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${escapeHtml(name)}</td><td>${def.type}</td><td>${escapeHtml(def.unitLabel||'')}</td><td>${def.locked?'yes':'no'}</td><td><button class='btn' data-del-unit='${escapeHtml(name)}'>Delete</button></td>`;
        ut.appendChild(tr);
      });
      ut.querySelectorAll('[data-del-unit]').forEach(b=>b.addEventListener('click',async ev=>{
        const key=ev.currentTarget.getAttribute('data-del-unit');
        delete state.unitDefaults[key];
        await saveAll();
        renderSettings();
      }));

      // Backfill tags from ingredients ‚Äî inject into Settings header
      (function addBackfillButton(){
        const header = document.querySelector('#settings-modal .toolbar');
        if(!header || document.getElementById('backfill-tags')) return;
        const btn = document.createElement('button');
        btn.className='btn';
        btn.id='backfill-tags';
        btn.textContent='Backfill tags from ingredients';
        header.appendChild(btn);
        btn.addEventListener('click', async ()=>{
          if(!state.meals.length) return alert('No meals saved.');
          let changed=0;
          for(const m of state.meals){
            const auto = ingredientNamesToTags(m.ingredients||[]);
            const set = new Set((m.tags||[]).map(t=>t.toLowerCase()));
            auto.forEach(t=>set.add(t));
            const next = Array.from(set);
            if(JSON.stringify(next)!==JSON.stringify(m.tags||[])){
              m.tags = next;
              changed++;
            }
          }
          await saveAll();
          refreshTagSuggestions();
          renderMeals();
          status(changed?`Backfilled tags on ${changed} meal${changed===1?'':'s'}.`:'Nothing to backfill.');
        });
      })();
    }

    $('#norm-add').addEventListener('click',async()=>{
      const c=$('#norm-canonical').value.trim();
      const a=$('#norm-aliases').value.split(',').map(s=>s.trim()).filter(Boolean);
      if(!c){alert('Enter a canonical name.');return;}
      state.normaliser.push({canonical:normaliseRaw(c),aliases:a.map(normaliseRaw)});
      $('#norm-canonical').value='';
      $('#norm-aliases').value='';
      await saveAll();
      renderSettings();
    });

    $('#unit-add').addEventListener('click',async()=>{
      const n=$('#unit-name').value.trim();
      const t=$('#unit-type').value;
      const l=$('#unit-label').value.trim();
      const locked=$('#unit-locked').checked;
      if(!n){alert('Enter an ingredient name.');return;}
      const key=normaliseKey(n);
      state.unitDefaults[key]={type:t,unitLabel:l||undefined,locked};
      $('#unit-name').value='';
      $('#unit-label').value='';
      $('#unit-locked').checked=false;
      await saveAll();
      renderSettings();
    });

    // ===== Init =====
    (async()=>{
      await loadAll();
      loadSelection();
      applyTheme();
      document.documentElement.style.setProperty('--card-min',state.prefs.gridMin==='compact'?'200px':state.prefs.gridMin==='cozy'?'260px':'320px');
      updateIngredientSuggestions();
      refreshTagSuggestions();
      renderMeals();
      renderShopping();
    })();

    function placeholderSvg(text){
      const t = (text||'Meal').slice(0,24).replace(/&/g,'&amp;').replace(/</g,'&lt;');
      const bg = '#1f2937', fg = '#cbd5e1';
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='640' height='360'>
        <rect width='100%' height='100%' fill='${bg}'/>
        <text x='50%' y='50%' fill='${fg}' font-family='system-ui,Segoe UI,Roboto' font-size='28' dominant-baseline='middle' text-anchor='middle'>${t}</text>
      </svg>`;
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    }
  </script>
 <script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js");
    });
  }
</script>
</body>
</html>